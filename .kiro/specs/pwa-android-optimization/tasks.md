# 实施计划: PWA 安卓优化

## 概述

本实施计划将优化金融工具箱 PWA 在安卓系统上的表现，确保应用能够以独立模式运行，提供完整的离线功能，并在各种安卓浏览器上正常工作。实施将分为以下几个阶段：配置优化、图标资源准备、HTML meta 标签添加、测试验证和文档更新。

## 任务

- [x] 1. 优化 Manifest 配置
  - 在 `vite.config.ts` 中更新 PWA manifest 配置
  - 添加 `orientation: 'portrait-primary'` 字段
  - 添加 `categories: ['finance', 'utilities']` 字段
  - 添加 `lang: 'zh-CN'` 字段
  - 添加 `dir: 'ltr'` 字段
  - 修改 `start_url: '/?source=pwa'` 添加来源追踪
  - _需求: 2.1, 2.2, 2.3, 2.4, 2.5_

- [ ]* 1.1 编写 Manifest 配置完整性属性测试
  - **属性 2: Manifest 必需字段完整性**
  - **验证需求: 2.1, 2.2, 2.3, 2.4**
  - 使用 fast-check 生成随机 manifest 配置
  - 验证所有必需字段存在且类型正确

- [ ]* 1.2 编写 Start URL 追踪参数属性测试
  - **属性 3: Start URL 追踪参数**
  - **验证需求: 2.5**
  - 验证 start_url 包含查询参数

- [ ] 2. 优化图标配置以支持安卓自适应图标
  - [x] 2.1 更新 manifest 中的图标配置
    - 确保现有的 192x192 和 512x512 图标同时配置为 `any` 和 `maskable` 用途
    - 验证图标文件路径正确
    - 确保 `includeAssets` 包含所有图标文件
    - _需求: 3.1, 3.2, 3.5_

  - [ ]* 2.2 编写图标配置完整性属性测试
    - **属性 4: 图标配置完整性**
    - **验证需求: 3.1, 3.2, 3.5**
    - 验证 icons 数组包含所需尺寸和用途的图标
    - 验证每个图标配置的格式正确

  - [x] 2.3 验证现有图标是否符合 maskable 规范
    - 检查图标设计是否有足够的安全区域
    - 如果需要，创建符合 maskable 规范的新图标
    - 确保重要内容在中心 80% 区域内
    - _需求: 3.3, 3.4_

- [x] 3. 添加 HTML Meta 标签支持
  - 在 `index.html` 中添加必需的 PWA meta 标签
  - 添加 `<meta name="theme-color" content="#1890ff">`
  - 添加 `<meta name="mobile-web-app-capable" content="yes">`
  - 添加 `<meta name="apple-mobile-web-app-capable" content="yes">`
  - 添加 `<meta name="apple-mobile-web-app-status-bar-style" content="default">`
  - 添加 `<meta name="apple-mobile-web-app-title" content="金融工具箱">`
  - 验证 manifest 链接标签存在
  - 更新 viewport meta 标签添加 `viewport-fit=cover`
  - _需求: 4.1, 4.2, 4.3, 4.4, 4.5_

- [ ]* 3.1 编写 Theme Color 一致性属性测试
  - **属性 5: Theme Color 一致性**
  - **验证需求: 4.1**
  - 读取 HTML 和 manifest 中的 theme_color
  - 验证两者值一致

- [ ]* 3.2 编写 HTML Meta 标签存在性单元测试
  - 验证所有必需的 meta 标签存在
  - 验证 manifest 链接标签存在
  - _需求: 4.2, 4.3, 4.4, 4.5_

- [ ] 4. 优化 Service Worker 配置
  - [x] 4.1 验证和优化 Workbox 缓存策略
    - 检查当前的 `globPatterns` 配置
    - 确保包含所有核心资源类型
    - 验证 `maximumFileSizeToCacheInBytes` 设置合理
    - 确认 `runtimeCaching` 配置适用于安卓
    - _需求: 6.1, 6.2_

  - [ ]* 4.2 编写 Service Worker 注册属性测试
    - **属性 6: Service Worker 注册**
    - **验证需求: 6.1**
    - 模拟首次访问场景
    - 验证 Service Worker 成功注册

  - [ ]* 4.3 编写核心资源缓存属性测试
    - **属性 7: 核心资源缓存**
    - **验证需求: 6.2**
    - 验证所有核心资源被缓存
    - 使用 Cache API 检查缓存内容

  - [x] 4.2 添加 Service Worker 错误处理
    - 在应用入口添加 Service Worker 注册逻辑
    - 添加注册失败的错误处理
    - 添加浏览器不支持的优雅降级
    - _需求: 6.1, 8.5_

- [ ] 5. 实现离线功能支持
  - [x] 5.1 验证离线缓存策略
    - 测试应用在离线状态下的加载
    - 确认核心计算功能在离线状态下可用
    - _需求: 6.3, 6.4_

  - [ ]* 5.2 编写离线功能可用性属性测试
    - **属性 8: 离线功能可用性**
    - **验证需求: 6.3, 6.4**
    - 模拟离线状态
    - 验证应用可以从缓存加载
    - 验证核心功能可用

  - [ ]* 5.3 编写 Service Worker 自动更新属性测试
    - **属性 9: Service Worker 自动更新**
    - **验证需求: 6.5**
    - 模拟新版本 Service Worker
    - 验证自动更新机制

- [x] 6. 检查点 - 确保所有配置正确且测试通过
  - 运行所有测试确保通过
  - 在开发环境验证 PWA 功能
  - 如有问题请询问用户

- [ ] 7. 实现 PWA 安装提示功能（可选）
  - [ ] 7.1 创建安装提示组件
    - 创建 `src/components/InstallPrompt.tsx` 组件
    - 监听 `beforeinstallprompt` 事件
    - 实现自定义安装提示 UI
    - 添加安装状态追踪逻辑
    - _需求: 7.1, 7.3, 7.5_

  - [ ]* 7.2 编写安装提示触发属性测试
    - **属性 10: 安装提示触发**
    - **验证需求: 7.1**
    - 模拟 beforeinstallprompt 事件
    - 验证事件被正确捕获

  - [ ]* 7.3 编写 PWA 安装标准合规性属性测试
    - **属性 11: PWA 安装标准合规性**
    - **验证需求: 7.2**
    - 验证 manifest 满足 Chrome 安装标准

  - [ ]* 7.4 编写已安装应用不显示提示属性测试
    - **属性 12: 已安装应用不显示提示**
    - **验证需求: 7.5**
    - 模拟独立模式运行
    - 验证安装提示不显示

  - [ ] 7.5 集成安装提示到应用
    - 在主应用中引入 InstallPrompt 组件
    - 配置合适的显示时机
    - 添加用户偏好记忆功能
    - _需求: 7.3, 7.5_

- [ ]* 7.6 编写优雅降级属性测试
  - **属性 13: 优雅降级**
  - **验证需求: 8.5**
  - 模拟不支持 Service Worker 的环境
  - 验证应用仍能正常运行

- [x] 8. 启动画面配置验证
  - 验证 manifest 中的 `background_color` 配置
  - 验证图标配置用于启动画面生成
  - 在真实安卓设备上测试启动画面显示
  - _需求: 5.1, 5.2, 5.3, 5.4, 5.5_

- [ ]* 8.1 编写启动画面配置单元测试
  - 验证 manifest 包含 background_color
  - 验证图标配置完整
  - _需求: 5.2_

- [x] 9. 跨浏览器兼容性验证
  - 在 Chrome for Android 上测试 PWA 安装和独立模式
  - 在 Samsung Internet 上测试（如可用）
  - 在 Firefox for Android 上测试基本功能
  - 在 Edge for Android 上测试（如可用）
  - 记录测试结果和发现的问题
  - _需求: 8.1, 8.2, 8.3, 8.4_

- [ ] 10. 独立模式运行验证
  - [x] 10.1 创建独立模式检测工具函数
    - 创建 `src/utils/pwa.ts` 工具文件
    - 实现 `isStandalone()` 函数检测独立模式
    - 实现 `isPWAInstalled()` 函数检测安装状态
    - _需求: 1.1, 1.3_

  - [ ]* 10.2 编写独立模式运行验证属性测试
    - **属性 1: 独立模式运行验证**
    - **验证需求: 1.1, 1.3**
    - 模拟独立模式环境
    - 验证检测函数正确工作

  - [x] 10.3 在应用中添加独立模式指示（可选）
    - 在开发环境显示当前运行模式
    - 帮助调试和验证
    - _需求: 1.1_

- [x] 11. 最终检查点 - 完整功能验证
  - 运行完整的测试套件
  - 使用 Lighthouse 进行 PWA 审计（目标评分 ≥ 90）
  - 在真实安卓设备上进行端到端测试
  - 验证所有需求都已满足
  - 如有问题请询问用户

- [x] 12. 文档更新
  - 更新项目 README 添加 PWA 功能说明
  - 添加安卓设备安装指南
  - 记录已知问题和浏览器兼容性
  - 添加开发环境 PWA 测试指南

## 注意事项

- 标记为 `*` 的任务是可选的测试任务，可以跳过以加快 MVP 开发
- 每个任务都引用了具体的需求以便追溯
- 检查点确保增量验证
- 属性测试验证通用正确性属性
- 单元测试验证特定示例和边缘情况
- 真实设备测试是验证安卓 PWA 功能的关键步骤
