# 部署架构说明

## 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                         用户访问                              │
│                    (浏览器/移动设备)                          │
└────────────────────────┬────────────────────────────────────┘
                         │
                         │ HTTPS (443) / HTTP (80)
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                    阿里云 ECS 服务器                          │
│                 (Alibaba Cloud Linux 3)                      │
│                                                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                   Nginx Web 服务器                    │   │
│  │                                                       │   │
│  │  • 端口: 80 (HTTP), 443 (HTTPS)                     │   │
│  │  • 反向代理和静态文件服务                            │   │
│  │  • Gzip 压缩                                         │   │
│  │  • 静态资源缓存                                       │   │
│  │  • SSL/TLS 终止 (Let's Encrypt)                     │   │
│  │  • 前端路由支持                                       │   │
│  └───────────────────┬─────────────────────────────────┘   │
│                      │                                       │
│                      │ 读取静态文件                          │
│                      ▼                                       │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  /www/program/金融工具箱/financial-calculation-tools/ │   │
│  │                                                       │   │
│  │  • index.html                                        │   │
│  │  • assets/                                           │   │
│  │    ├── js/                                           │   │
│  │    │   ├── react-vendor-[hash].js                   │   │
│  │    │   ├── antd-vendor-[hash].js                    │   │
│  │    │   ├── echarts-vendor-[hash].js                 │   │
│  │    │   └── main-[hash].js                           │   │
│  │    ├── css/                                          │   │
│  │    └── images/                                       │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                               │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                  系统服务                              │   │
│  │                                                       │   │
│  │  • Firewall (firewalld)                             │   │
│  │  • fail2ban (防暴力破解)                             │   │
│  │  • Certbot (SSL 证书自动续期)                        │   │
│  │  • Cron (定时备份)                                   │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

## 数据流向

### 1. 用户请求流程
```
用户浏览器
    │
    ├─→ 输入域名 (https://your-domain.com)
    │
    ├─→ DNS 解析 → 服务器 IP
    │
    ├─→ HTTPS 请求 (443 端口)
    │
    ├─→ Nginx 接收请求
    │
    ├─→ SSL/TLS 解密
    │
    ├─→ 路由匹配
    │   ├─ /assets/* → 直接返回静态资源 (缓存 1 年)
    │   └─ 其他路径 → 返回 index.html (前端路由)
    │
    └─→ 返回响应 (Gzip 压缩)
```

### 2. 部署流程
```
本地开发机
    │
    ├─→ npm run build (构建项目)
    │
    ├─→ 生成 dist/ 目录
    │
    ├─→ ./deploy.sh (执行部署脚本)
    │
    ├─→ rsync 同步文件到服务器
    │   └─→ /www/program/金融工具箱/financial-calculation-tools/
    │
    ├─→ 设置文件权限 (nginx:nginx 755)
    │
    ├─→ 测试 Nginx 配置 (nginx -t)
    │
    └─→ 重新加载 Nginx (systemctl reload nginx)
```

## 目录结构

### 服务器端目录
```
/
├── www/
│   └── program/
│       └── 金融工具箱/
│           └── financial-calculation-tools/  # 网站根目录
│               ├── index.html
│               ├── assets/
│               ├── favicon.ico
│               └── robots.txt
├── var/
│   └── log/
│       └── nginx/
│           ├── financial-toolbox-access.log  # 访问日志
│           └── financial-toolbox-error.log   # 错误日志
├── etc/
│   ├── nginx/
│   │   └── conf.d/
│   │       └── financial-toolbox.conf   # Nginx 配置
│   └── letsencrypt/                     # SSL 证书
│       └── live/
│           └── your-domain.com/
│               ├── fullchain.pem
│               └── privkey.pem
└── root/
    ├── backups/                         # 备份目录
    │   └── financial-toolbox-*.tar.gz
    └── backup-website.sh                # 备份脚本
```

## 网络架构

### 端口配置
```
┌──────────────────────────────────────────┐
│         阿里云安全组规则                  │
├──────────────────────────────────────────┤
│ 入方向:                                   │
│  • TCP 22  (SSH)      - 管理访问         │
│  • TCP 80  (HTTP)     - Web 访问         │
│  • TCP 443 (HTTPS)    - 安全 Web 访问    │
├──────────────────────────────────────────┤
│ 出方向:                                   │
│  • 全部允许                               │
└──────────────────────────────────────────┘

┌──────────────────────────────────────────┐
│         服务器防火墙 (firewalld)          │
├──────────────────────────────────────────┤
│  • http (80)    - 允许                   │
│  • https (443)  - 允许                   │
│  • ssh (22)     - 允许                   │
└──────────────────────────────────────────┘
```

## 性能优化

### 1. 代码分割
```
构建产物:
├── react-vendor-[hash].js      (~150KB)  # React 相关
├── antd-vendor-[hash].js        (~500KB)  # Ant Design
├── echarts-vendor-[hash].js     (~800KB)  # ECharts
├── utils-vendor-[hash].js       (~50KB)   # 工具库
└── main-[hash].js               (~100KB)  # 业务代码

优势:
• 并行加载
• 浏览器缓存
• 按需加载
```

### 2. 缓存策略
```
资源类型          缓存时间      Cache-Control
─────────────────────────────────────────────
HTML 文件         不缓存        no-cache
JS/CSS 文件       1 年          public, immutable
图片/字体         1 年          public, immutable
```

### 3. 压缩优化
```
Gzip 压缩:
• HTML: ~70% 压缩率
• CSS:  ~80% 压缩率
• JS:   ~70% 压缩率

示例:
main.js:     100KB → 30KB
antd.css:    200KB → 40KB
```

## 安全架构

### 1. 网络层安全
```
┌─────────────────────────────────────┐
│         防火墙 (firewalld)           │
│  • 只开放必要端口                    │
│  • 拒绝其他所有入站流量              │
└─────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│         fail2ban                     │
│  • 监控 SSH 登录失败                 │
│  • 自动封禁恶意 IP                   │
└─────────────────────────────────────┘
```

### 2. 应用层安全
```
┌─────────────────────────────────────┐
│         Nginx 安全配置               │
│  • 隐藏版本号                        │
│  • 安全头部                          │
│  • 禁止访问隐藏文件                  │
│  • 请求大小限制                      │
└─────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│         SSL/TLS (Let's Encrypt)      │
│  • TLS 1.2/1.3                      │
│  • 强加密套件                        │
│  • HSTS                             │
│  • 自动续期                          │
└─────────────────────────────────────┘
```

## 备份策略

### 自动备份流程
```
Cron 定时任务 (每天 02:00)
    │
    ├─→ 执行 /root/backup-website.sh
    │
    ├─→ 打包网站目录
    │   tar -czf financial-toolbox-YYYYMMDD_HHMMSS.tar.gz
    │
    ├─→ 保存到 /root/backups/
    │
    └─→ 清理 7 天前的旧备份
```

### 部署时备份
```
部署脚本执行时
    │
    ├─→ 检查是否有旧版本
    │
    ├─→ 如果有，创建备份
    │   cp -r /www/program/金融工具箱/financial-calculation-tools \
    │      /www/program/金融工具箱/financial-calculation-tools.backup.YYYYMMDD_HHMMSS
    │
    └─→ 继续部署新版本
```

## 监控和日志

### 日志系统
```
Nginx 访问日志
    │
    ├─→ /var/log/nginx/financial-toolbox-access.log
    │   • 记录所有访问请求
    │   • IP、时间、URL、状态码、响应时间
    │
Nginx 错误日志
    │
    └─→ /var/log/nginx/financial-toolbox-error.log
        • 记录所有错误
        • 404、500 等错误
        • 配置错误
```

### 监控指标
```
系统资源:
• CPU 使用率
• 内存使用率
• 磁盘使用率
• 网络流量

应用指标:
• 请求数量
• 响应时间
• 错误率
• 并发连接数
```

## 扩展性

### 水平扩展（未来）
```
┌─────────────┐
│   负载均衡   │
│   (SLB)     │
└──────┬──────┘
       │
   ┌───┴───┐
   │       │
   ▼       ▼
┌─────┐ ┌─────┐
│ECS-1│ │ECS-2│
└─────┘ └─────┘
```

### 添加后端服务（未来）
```
┌──────────┐
│  Nginx   │
└────┬─────┘
     │
     ├─→ /api/*  → 后端服务 (Node.js/Python)
     │
     └─→ /*      → 前端静态文件
```

## 成本优化

### 资源使用
```
当前配置 (1核2G):
• CPU: 通常 < 10%
• 内存: 约 500MB-1GB
• 磁盘: 约 2-5GB
• 带宽: 按实际使用

优化建议:
• 使用 CDN 减少带宽成本
• 按量付费带宽
• 定期清理日志和备份
```

---

## 总结

这个架构具有以下特点：

✅ **简单**: 单服务器部署，易于管理  
✅ **高效**: 静态文件服务，性能优秀  
✅ **安全**: 多层安全防护  
✅ **可靠**: 自动备份，易于恢复  
✅ **经济**: 成本可控，约 60-100 元/月  
✅ **可扩展**: 未来可以轻松扩展

适合中小型项目和个人开发者使用。
